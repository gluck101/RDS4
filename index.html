<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KITCHEN DISPLAY SYSTEM</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyADpwAEF3fW5lHmLeAROZUicntXhyv7obo",
      authDomain: "order-to-kitchen.firebaseapp.com",
      databaseURL: "https://order-to-kitchen-default-rtdb.firebaseio.com",
      projectId: "order-to-kitchen",
      storageBucket: "order-to-kitchen.appspot.com",
      messagingSenderId: "850969106226",
      appId: "1:850969106226:web:3c8e3efe31e7b28371692b",
      measurementId: "G-LV04KC1NHT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
  
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="background-container">
  </div>
  <div class="container">
    <!-- Main Section for Ordering -->
    <div id="main-section">
      <h2>RAB'S KITCHEN RESTAURANT DISPLAY SYSTEM</h2>

      <div class="heading-container">
        <span class="blinking-brackets">&lt;&lt;</span>
        <h6 class="order-heading">PLACE YOUR ORDER HERE</h6>
        <span class="blinking-brackets">&lt;&lt;</span>
      </div>
    
      <div class="heading-container">
        <span class="blinking-brackets">&lt;&lt;</span>
        <h6 class="order-heading">Use the Voice Note System to Send Instructions to the Chef</h6>
        <span class="blinking-brackets">&lt;&lt;</span>
      </div>
    
      <div class="heading-container">
        <span class="blinking-brackets">&lt;&lt;</span>
        <h6 class="order-heading">The System will Notify You of Your Order's ETC (Estimated Time of Completion)</h6>
        <span class="blinking-brackets">&lt;&lt;</span>
      </div>
    
      <div class="heading-container">
        <span class="blinking-brackets">&lt;&lt;</span>
        <h6 class="order-heading">The System will Alert You When Your Order is Ready</h6>
        <span class="blinking-brackets">&lt;&lt;</span>
      </div>
    
      <div class="heading-container">
        <span class="blinking-brackets">&lt;&lt;</span>
        <h6 class="order-heading">Use the Analytics to Get Real-time Updates on Your Order Volume</h6>
        <span class="blinking-brackets">&lt;&lt;</span>
      </div>
    


      <div id="dish-container">
        <button class="order-btn" onclick="addItemToCart('Acheke and Tilapia 120 DINE-IN', 120)">Acheke and Tilapia 120 DINE-IN</button>
        <button class="order-btn" onclick="addItemToCart('Acheke and Tilapia 120 TAKE-OUT', 120)" style="background-color: orange;">Acheke and Tilapia 120 TAKE-OUT</button>
        <button class="order-btn" onclick="addItemToCart('Acheke and Tilapia 150 DINE-IN', 150)">Acheke and Tilapia 150 DINE-IN</button>
        <button class="order-btn" onclick="addItemToCart('Banku and Tilapia 120 TAKE-OUT', 120)" >Banku and Tilapia 120 TAKE-OUT</button>
        <button class="order-btn" onclick="addItemToCart('Extra Egg 5', 5)"  style="background-color: rgb(221, 15, 67);">Extra Egg</button>
        <button class="order-btn" onclick="addItemToCart('Acheke and Tilapia 150 TAKE-OUT', 150)">Acheke and Tilapia 150 TAKE-OUT</button>
        <button class="order-btn" onclick="addItemToCart('Banku and Tilapia 100 DINE-IN', 100)">Banku and Tilapia 100 DINE-IN</button>
        <button class="order-btn" onclick="addItemToCart('Banku and Tilapia 100 TAKE-OUT', 100)">Banku and Tilapia 100 TAKE-OUT</button>
        <button class="order-btn" onclick="addItemToCart('Bank and Tilapia 120 DINE-IN', 120)" style="background-color: purple;">Banku and Tilapia 120 DINE-IN</button>
        <button class="order-btn" onclick="addItemToCart('Extra Plantain 10', 10)">Extra Plantain</button>
        <button class="order-btn" onclick="addItemToCart('Extra Red Chili 5', 5)">Extra Red Chili</button>
        <button class="order-btn" onclick="addItemToCart('Extra Green Chili 5', 5)">Extra Green Chili</button>
        <button class="order-btn" onclick="addItemToCart('Extra Acheke 10', 10)">Extra Acheke</button>
        <button class="order-btn" onclick="addItemToCart('FriedRice 25', 25)">Fried Rice</button>
        <button class="order-btn" onclick="addItemToCart('Mayonnaise 25', 25)">Mayonnaise</button>

        <button class="order-btn" onclick="addItemToCart('Jollof Rice 25', 25)">Jollof Rice</button>
        <button class="order-btn" onclick="addItemToCart('Plain Rice 20', 20)">Plain Rice</button>
        <button class="order-btn" onclick="addItemToCart('Grilled Chicken 40', 40)">Grilled Chicken</button>
        <button class="order-btn" onclick="addItemToCart('Chofi 30', 30)">Chofi</button>
        <button class="order-btn" onclick="addItemToCart('Boiled Egg 5', 5)">Boiled Egg</button>
        <button class="order-btn" onclick="addItemToCart('Boiled Egg 5', 5)" style="background-color: orange;">Boiled Egg</button>
        <button class="order-btn" onclick="addItemToCart('Fried Chicken 20', 20)">Fried Chicken</button>
        <button class="order-btn" onclick="addItemToCart('Ketchup 5', 5)">Ketchup</button>
        <button class="order-btn" onclick="addItemToCart('Coldslaw 5', 5)" style="background-color: rgb(221, 15, 67);">Coldslaw</button>
      </div>

      <!-- Cart Section -->
      <div id="cart-container">
        <h3>SENDING TO KITCHEN:</h3>
      </div>

      <!-- Order Form -->
      <form id="order-form">
        <label for="staff-name">Staff Name:</label>
        <input type="text" id="staff-name" required>

        <label for="dine-in-takeout">Dine-In or Takeout:</label>
        <select id="dine-in-takeout">
          <option value="Dine-In">Dine-In</option>
          <option value="Takeout">Takeout</option>
        </select>

        <label for="now-later">Order Time:</label>
        <select id="now-later" onchange="checkOrderTime()">
          <option value="Now">Now</option>
          <option value="Later">Later</option>
        </select>

        <div id="later-time-input" style="display: none;">
          <label for="order-time">Select Time:</label>
          <input type="time" id="order-time">
        </div>

        <!-- Voice Note Recording Section -->
        <div id="voice-note-section">
          <button type="button" id="record-button" onclick="startRecording()" class="record-button">
            <span class="record-icon">üî¥</span> Record Voice Note
          </button>
          <button type="button" id="stop-record-button" class="record-button hidden" onclick="stopRecording()">Stop Recording</button>
          <audio id="audio-preview" controls class="hidden"></audio>
        </div>

        <button type="submit">Send Order</button>
      </form>
    </div>

    <!-- Pending Orders Section -->
    <div id="pending-orders-section">
      <h3>Pending Orders:</h3>
      <div id="pending-orders-container"></div>
    </div>
  </div>

<!-- Voice Messaging Section -->
<div class="container">
  <div id="voice-note-section">
    <h3>Send Messaging</h3>
    <div id="voice-controls">
      <button id="voice-record-button" onclick="startVoiceRecording()">üéôÔ∏è Start Recording</button>
      <button id="voice-stop-button" class="hidden" onclick="stopVoiceRecording()">‚èπÔ∏è Stop Recording</button>

      <!-- Progress Bar -->
      <div id="voice-progress-bar" class="progress-bar hidden">
        <div id="voice-progress-fill"></div>
      </div>
      <p id="voice-recording-time" class="hidden">Recording: 0 seconds</p>

      <audio id="voice-preview" controls class="hidden"></audio>
      <button id="voice-send-button" class="hidden" onclick="sendVoiceNote()">üì§ Send Message</button>
    </div>
  </div>

  <!-- Container for Sent Messages -->
  <div id="sent-messages-container">
    <!-- Sent messages will appear here -->
  </div>
</div>


  <!-- Incoming Messages Section -->
  <div id="incoming-messages-section">
    <h3>Incoming Messages</h3>
    <div id="incoming-messages-container"></div>
  </div>

  <!-- Analytical Section -->
  <div id="orders-by-date-container"></div>
  
  <button onclick="fetchOrdersGroupedByDateAndCountTilapia()">ANALYTICAL</button>

  <!-- Order History Section -->
  <button id="view-history-button" onclick="showOrderHistory()">View Order History</button>
  <div id="order-history-section" class="hidden">
    <h2>Order History</h2>
    <div id="order-history-container"></div>
    <button id="go-back-button" onclick="showMainSection()">Go Back</button>
  </div>

  <div class="background-side-container"></div>
</div>
div>
    

      

  

  

  

  

  

  

  

  

  

    

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


  
<script>
  // Initialize global variables
  let cartItems = [];
  let audioChunks = [];
  let audioBase64 = ""; // Stores the Base64 string of the recorded audio
  let mediaRecorder;

  // Add item to cart
  function addItemToCart(name, price) {
    const itemIndex = cartItems.findIndex(item => item.name === name);
    if (itemIndex >= 0) {
      cartItems[itemIndex].quantity += 1;
    } else {
      cartItems.push({ name, price, quantity: 1 });
    }
    updateCartDisplay();
  }

  // Update cart display
function updateCartDisplay() {
  const cartContainer = document.getElementById('cart-container');
  cartContainer.innerHTML = '<h3>To Kitchen:</h3>';

  cartItems.forEach((item, index) => {
    const cartItemDiv = document.createElement('div');
    cartItemDiv.classList.add('cart-item');
    cartItemDiv.innerHTML = `
      ${item.name} - GHS ${item.price} x ${item.quantity}
      <button onclick="removeItemFromCart(${index})" class="delete-button">Delete</button>
    `;

    // Add event listener to toggle selection on click
    cartItemDiv.addEventListener('click', () => {
      cartItemDiv.classList.toggle('selected');
    });

    cartContainer.appendChild(cartItemDiv);
  });
}

  // Remove item from cart
  function removeItemFromCart(index) {
    cartItems.splice(index, 1);
    updateCartDisplay();
  }

  // Start recording voice note
  async function startRecording() {
    audioChunks = [];
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        reader.onloadend = () => {
          audioBase64 = reader.result;
          document.getElementById('audio-preview').src = audioBase64;
          document.getElementById('audio-preview').classList.remove("hidden");
        };
      };
      mediaRecorder.start();
      document.getElementById('record-button').classList.add('hidden');
      document.getElementById('stop-record-button').classList.remove('hidden');
    } catch (error) {
      console.error("Microphone access denied or error:", error);
      alert("Please enable microphone access to record voice notes.");
    }
  }

  // Stop recording voice note
  function stopRecording() {
    if (mediaRecorder) {
      mediaRecorder.stop();
      document.getElementById('record-button').classList.remove('hidden');
      document.getElementById('stop-record-button').classList.add('hidden');
    }
  }

  // Handle order form submission
  document.getElementById('order-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const staffName = document.getElementById('staff-name').value;
    const dineInTakeout = document.getElementById('dine-in-takeout').value;
    const nowLater = document.getElementById('now-later').value;
    const orderTime = document.getElementById('order-time').value || 'Now';

    if (cartItems.length === 0) {
      alert("Please add at least one item to the cart.");
      re;
    }

    
     

    const orderData = {
      staffName,
      dineInTakeout,
      orderTime,
      items: cartItems,
      timestamp: new Date().toISOString(),
      voiceNote: audioBase64
    };

    const ordersRef = firebase.database().ref('orders');
    ordersRef.push(orderData)
      .then((newOrderRef) => {
        alert("Order sent with voice note!");
        listenForOrderTimers(newOrderRef.key);
        displayPendingOrder(orderData, "Waiting for confirmation...", newOrderRef.key);
        resetForm();
      })
      .catch(error => {
        console.error("Error saving order:", error);
        alert("There was an error submitting your order. Please try again.");
      });
  });

  // Reset form after order submission
  function resetForm() {
    document.getElementById('order-form').reset();
    cartItems = [];
    audioBase64 = "";
    updateCartDisplay();
    document.getElementById('audio-preview').classList.add("hidden");
    document.getElementById('later-time-input').style.display = 'none';
  }

  // Check order time selection
  function checkOrderTime() {
    const nowLater = document.getElementById('now-later').value;
    document.getElementById('later-time-input').style.display = nowLater === 'Later' ? 'block' : 'none';
  }

  
  
  
  
  
  // Listen for order timers
  
  // Listen for order timers and check order status in orderHistory
 
  function listenForOrderTimers(orderKey) {
    const orderRef = firebase.database().ref(`orders/${orderKey}`);
    const orderHistoryRef = firebase.database().ref(`orderHistory/${orderKey}`);

    // Listen for changes in the 'orders' node for timers
    orderRef.on('value', snapshot => {
        const orderData = snapshot.val();
        if (orderData) {
            if (orderData.estimatedTime && !orderData.extraTime) {
                displayPendingOrder(orderData, `This order will take ${orderData.estimatedTime} minutes.`, orderKey);
                startCountdown(orderData.estimatedTime * 60, `countdown-${orderKey}`, orderKey);
            } else if (orderData.extraTime) {
                displayPendingOrder(orderData, `Extra time of ${orderData.extraTime} minutes added.`, orderKey);
                startCountdown(orderData.extraTime * 60, `countdown-${orderKey}`, orderKey);
            }
        }
    });

    // Listen for status updates in 'orderHistory' for completed or cancelled status
    orderHistoryRef.on('value', snapshot => {
        const orderHistoryData = snapshot.val();
        if (orderHistoryData) {
            let message = "";
            if (orderHistoryData.status === "Completed") {
                message = "Your order is ready and Completed.";
                orderHistoryData.completedTimestamp = orderHistoryData.completedTimestamp || new Date().toISOString();
                orderHistoryRef.update({ completedTimestamp: orderHistoryData.completedTimestamp });
            } else if (orderHistoryData.status === "Cancelled Order") {
                message = "Your order has been cancelled.";
                orderHistoryData.cancelledTimestamp = orderHistoryData.cancelledTimestamp || new Date().toISOString();
                orderHistoryRef.update({ cancelledTimestamp: orderHistoryData.cancelledTimestamp });
            }

            if (message) {
                displayPendingOrder(orderHistoryData, message, orderKey);
            }
        }
    });
}
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  // Display pending orders
  
  
  
  
  function displayPendingOrder(orderData, message, orderKey) {
    const pendingOrdersContainer = document.getElementById('pending-orders-container');
    let orderDiv = document.getElementById(`order-${orderKey}`);

    // Check if the order div already exists, otherwise create it
    if (!orderDiv) {
        orderDiv = document.createElement('div');
        orderDiv.id = `order-${orderKey}`;
        orderDiv.classList.add('pending-order-item');
        pendingOrdersContainer.appendChild(orderDiv);
    }

    // Start table structure for pending items
    let itemsList = '<table class="pending-order-table">';
    itemsList += ``;
    itemsList += `<tbody>`;
    // Loop through order items and populate table rows
    orderData.items.forEach(item => {
        itemsList += `<tr><td>${item.name}</td><td>${item.quantity}</td></tr>`;
    });
    itemsList += '</tbody></table>';

    // Format timestamps
    const formattedTimestamp = new Date(orderData.timestamp).toLocaleString();
    let completionMessage = "";

    // Display Completed or Cancelled timestamp if available
    if (orderData.completedTimestamp) {
        completionMessage = `<p><strong>Completed At:</strong> ${new Date(orderData.completedTimestamp).toLocaleString()}</p>`;
    } else if (orderData.cancelledTimestamp) {
        completionMessage = `<p><strong>Cancelled At:</strong> ${new Date(orderData.cancelledTimestamp).toLocaleString()}</p>`;
    }

    const countdownId = `countdown-${orderKey}`;
    orderDiv.innerHTML = `
        <p><strong>Staff Name:</strong> ${orderData.staffName}</p>
        <p><strong>Order Time:</strong> ${orderData.orderTime || 'Now'}</p>
        <p><strong>Dine-In or Takeout:</strong> ${orderData.dineInTakeout}</p>
        <p><strong>Timestamp:</strong> ${formattedTimestamp}</p>
        <p><strong>Items:</strong></p>
        ${itemsList} <!-- Insert table here -->
        <p>${message}</p>
        ${completionMessage}
        <p id="${countdownId}" class="countdown-timer">Time Remaining: --:--</p>
    `;

    // Show "OK" button if the order is completed or cancelled
    if (message.includes("Completed") || message.includes("cancelled")) {
        showOKButton(orderKey);
    }

    // Start countdown if estimated time is provided
    const estimatedTimeMatch = message.match(/(\d+) minutes/);
    if (estimatedTimeMatch) {
        const estimatedTime = parseInt(estimatedTimeMatch[1], 10);
        startCountdown(estimatedTime * 60, countdownId, orderKey);
    }
}


  
  
  
  
  
  
  
  
  
  
  
  

  // Start countdown timer
  function startCountdown(seconds, countdownId, orderKey) {
    const countdownDisplay = document.getElementById(countdownId);
    if (!countdownDisplay) return;
    const interval = setInterval(() => {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      countdownDisplay.innerHTML = `Time Remaining: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      seconds--;
      if (seconds < 0) {
        clearInterval(interval);
        countdownDisplay.innerHTML = "Time's Up!";
        countdownDisplay.classList.add("blinking");
        showOKButton(orderKey);
      }
    }, 1000);
  }

  // Show OK button for completed/cancelled orders
  function showOKButton(orderKey) {
    const orderDiv = document.getElementById(`order-${orderKey}`);
    if (orderDiv) {
      const existingButton = orderDiv.querySelector('.ok-button');
      if (!existingButton) {
        const okButton = document.createElement('button');
        okButton.textContent = "OK";
        okButton.className = "ok-button";
        okButton.style.marginTop = "10px";
        okButton.onclick = function() {
          removePendingOrder(orderKey);
        };
        orderDiv.appendChild(okButton);
      }
    }
  }

  // Remove pending order
  function removePendingOrder(orderKey) {
    const orderDiv = document.getElementById(`order-${orderKey}`);
    if (orderDiv) {
      orderDiv.remove();
      console.log(`Order with key ${orderKey} has been removed.`);
    }
  }
  
  
  
  
  
  

  // Fetch order history
  function fetchOrderHistory() {
    const orderHistoryRef = firebase.database().ref('orderHistory');
    const historyContainer = document.getElementById('order-history-container');
    historyContainer.innerHTML = ''; // Clear existing content

    orderHistoryRef.once('value', (snapshot) => {
        const orderHistoryData = snapshot.val();

        for (const orderKey in orderHistoryData) {
            const order = orderHistoryData[orderKey];

            // Create a table for the items
            let itemsTable = `
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            order.items.forEach(item => {
                itemsTable += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                    </tr>
                `;
            });

            itemsTable += `</tbody></table>`;

            // Adding timestamps for completed or cancelled orders
            let statusTimestamp = '';
            if (order.completedTimestamp) {
                statusTimestamp = `<p><em>Completed At: ${new Date(order.completedTimestamp).toLocaleString()}</em></p>`;
            } else if (order.cancelledTimestamp) {
                statusTimestamp = `<p><em>Cancelled At: ${new Date(order.cancelledTimestamp).toLocaleString()}</em></p>`;
            }

            // Determine status styling
            let statusClass = '';
            if (order.status === 'Completed') statusClass = 'status-completed';
            if (order.status === 'Cancelled Order') statusClass = 'status-cancelled';

            // Create the order item
            const orderDiv = document.createElement('div');
            orderDiv.classList.add('order-history-item');
            orderDiv.innerHTML = `
                <p><strong>Staff Name:</strong> ${order.staffName || 'N/A'}</p>
                <p><strong>Order Time:</strong> ${order.orderTime || 'Now'}</p>
                <p><strong>Dine-In or Takeout:</strong> ${order.dineInTakeout}</p>
                <p><strong>Timestamp:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                <p><strong>Items:</strong></p>
                ${itemsTable}
                <p><strong>Status:</strong> 
                    <span class="${statusClass}">${order.status || 'Pending'}</span>
                </p>
                ${statusTimestamp}
            `;

            // Append to the history container
            historyContainer.appendChild(orderDiv);
        }
    });
}

  
  
  
  
  
  

  // Listen for status updates in order history
  

       
  

  
                
            

          
  
  function listenForOrderHistoryStatus(orderKey, orderData) {
    const orderHistoryRef = firebase.database().ref(`orderHistory/${orderKey}`);

    orderHistoryRef.on('value', (snapshot) => {
        const orderHistoryData = snapshot.val();
        console.log("Order history updated for:", orderKey, orderHistoryData); // Log all changes
        if (orderHistoryData) {
            let message;
            let completionTimestamp = null;

            if (orderHistoryData.status === "Completed") {
                console.log("Order status is Completed."); // Log specific status
                message = "Your order is ready and Completed.";

                if (!orderHistoryData.completedTimestamp) {
                    completionTimestamp = new Date().toISOString();
                    orderHistoryRef.update({ completedTimestamp: completionTimestamp });
                } else {
                    completionTimestamp = orderHistoryData.completedTimestamp;
                }

            } else if (orderHistoryData.status === "Cancelled Order") {
                console.log("Order status is Cancelled."); // Log specific status
                message = "Your order has been cancelled.";

                if (!orderHistoryData.cancelledTimestamp) {
                    completionTimestamp = new Date().toISOString();
                    orderHistoryRef.update({ cancelledTimestamp: completionTimestamp });
                } else {
                    completionTimestamp = orderHistoryData.cancelledTimestamp;
                }
            }

            if (message) {
                console.log("Displaying order and triggering TTS:", message); // Confirm message before TTS
                orderData.completionTimestamp = completionTimestamp;
                displayPendingOrder(orderData, message, orderKey, completionTimestamp);

                // Trigger TTS
                readOutText(message, 3);
            }
        }
    });
}
  
  
  
  
  
  function listenForIncomingMessages() {
    const messagesContainer = document.getElementById('incoming-messages-container');
    messagesContainer.innerHTML = ''; // Clear any existing messages
    const thisTabletId = "TabletA"; // Identify this tablet

    // Listen for new messages in the 'messages' node
    db.ref('messages').on('child_added', snapshot => {
        const messageData = snapshot.val();
        const messageId = snapshot.key;

        // Skip messages sent by this tablet
        if (messageData.sender === thisTabletId) return;

        // Create a message element for display
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-item');
        messageDiv.id = `message-${messageId}`;

        // Build message UI
        messageDiv.innerHTML = `
            <p><strong>Sender:</strong> ${messageData.sender}</p>
            <p><strong>Received At:</strong> ${new Date(messageData.timestamp).toLocaleString()}</p>
            <audio controls src="${messageData.voiceNote}"></audio>
            <button onclick="removeMessage('${messageId}')">OK</button>
        `;

        // Add the message to the container
        messagesContainer.appendChild(messageDiv);
    });

    // Handle empty state
    db.ref('messages').on('value', snapshot => {
        if (!snapshot.exists()) {
            messagesContainer.innerHTML = '<p>No messages yet.</p>';
        }
    });
}
  
  
  
  
// Show order history view
function showOrderHistory() {
    // Hide all other sections
    document.getElementById('main-section').classList.add('hidden');
    document.getElementById('pending-orders-section').classList.add('hidden');
    document.getElementById('incoming-messages-section').classList.add('hidden');
    document.getElementById('voice-note-section').classList.add('hidden');

    // Show only the order history section
    document.getElementById('order-history-section').classList.remove('hidden');

    // Fetch history each time the history view is shown
    fetchOrderHistory();
}

// Show main view
function showMainSection() {
    // Hide the history section
    document.getElementById('order-history-section').classList.add('hidden');

    // Restore all other sections
    document.getElementById('main-section').classList.remove('hidden');
    document.getElementById('pending-orders-section').classList.remove('hidden');
    document.getElementById('incoming-messages-section').classList.remove('hidden');
    document.getElementById('voice-note-section').classList.remove('hidden');
}  
  
  
  
  
  
  function removeMessage(messageId) {
    const confirmation = confirm("Are you sure you want to delete this message?");
    if (!confirmation) return;

    // Remove from Firebase
    db.ref(`messages/${messageId}`).remove()
        .then(() => {
            // Remove from UI
            const messageDiv = document.getElementById(`message-${messageId}`);
            if (messageDiv) {
                messageDiv.remove();
            }
            alert("Message deleted successfully.");
        })
        .catch(error => {
            console.error("Error deleting message:", error);
            alert("Failed to delete message. Please try again.");
        });
}
  
  
  
  window.onload = function () {
    listenForIncomingMessages(); // Start listening for incoming messages
};
  
 // Firebase Initialization (Reused)


// Variables for Voice Note Recording
let voiceMediaRecorder;
let voiceChunks = [];
let voiceBase64 = "";
let voiceRecordingSeconds = 0;
let voiceRecordingInterval;

// Start Voice Recording
async function startVoiceRecording() {
  voiceChunks = [];
  voiceRecordingSeconds = 0;

  // Show progress bar and recording time
  document.getElementById('voice-progress-bar').classList.remove('hidden');
  document.getElementById('voice-recording-time').classList.remove('hidden');
  updateVoiceRecordingProgress();

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    voiceMediaRecorder = new MediaRecorder(stream);
    voiceMediaRecorder.ondataavailable = event => voiceChunks.push(event.data);

    voiceMediaRecorder.onstop = () => {
      const audioBlob = new Blob(voiceChunks, { type: 'audio/wav' });
      const reader = new FileReader();
      reader.readAsDataURL(audioBlob);
      reader.onloadend = () => {
        voiceBase64 = reader.result;
        document.getElementById('voice-preview').src = voiceBase64;
        document.getElementById('voice-preview').classList.remove('hidden');
        document.getElementById('voice-send-button').classList.remove('hidden');
      };
    };

    voiceMediaRecorder.start();
    document.getElementById('voice-record-button').classList.add('hidden');
    document.getElementById('voice-stop-button').classList.remove('hidden');
  } catch (error) {
    console.error("Microphone access denied or error:", error);
    alert("Please enable microphone access to record voice messages.");
  }
}

// Stop Voice Recording
function stopVoiceRecording() {
  if (voiceMediaRecorder) {
    voiceMediaRecorder.stop();
    clearInterval(voiceRecordingInterval); // Stop progress updates
    document.getElementById('voice-record-button').classList.remove('hidden');
    document.getElementById('voice-stop-button').classList.add('hidden');
    document.getElementById('voice-progress-bar').classList.add('hidden');
    document.getElementById('voice-recording-time').classList.add('hidden');
  }
}

// Update Voice Recording Progress
function updateVoiceRecordingProgress() {
  const progressFill = document.getElementById('voice-progress-fill');
  const timeText = document.getElementById('voice-recording-time');

  voiceRecordingInterval = setInterval(() => {
    voiceRecordingSeconds++;
    timeText.textContent = `Recording: ${voiceRecordingSeconds} seconds`;

    const progressPercent = Math.min((voiceRecordingSeconds / 60) * 100, 100);
    progressFill.style.width = `${progressPercent}%`;

    if (voiceRecordingSeconds >= 60) {
      clearInterval(voiceRecordingInterval);
      stopVoiceRecording();
      alert("Maximum recording time reached!");
    }
  }, 1000);
}

// Send Voice Note to Database
function sendVoiceNote() {
  const senderId = "TabletA"; // Identify this tablet as the sender

  if (!voiceBase64) {
    alert("Please record a voice message before sending.");
    return;
  }

  // Disable the send button to prevent multiple submissions
  document.getElementById('voice-send-button').disabled = true;

  const messageData = {
    sender: senderId,
    timestamp: new Date().toISOString(),
    voiceNote: voiceBase64,
    listened: false,  // Initially false when sent
  };

  console.log("Sending message data to Firebase:", messageData);  // Log message data before sending

  // Push the message data to Firebase Realtime Database under the 'messages' node
  db.ref('messages').push(messageData)
    .then(snapshot => {
      const messageId = snapshot.key;
      console.log(`Message sent successfully, ID: ${messageId}`);

      // Immediately display the message in the UI after it's sent
      displaySentMessage(messageData, messageId); 

      // Optionally show a success message and remove after a short time
      showSuccessMessage();
      setTimeout(() => {
        hideSuccessMessage();
      }, 2000);  // Hide after 2 seconds

      // Reset the form after sending the message
      resetVoiceMessageForm();
      
      // Re-enable the send button after the message is sent
      document.getElementById('voice-send-button').disabled = false;
    })
    .catch(error => {
      console.error("Error sending voice message:", error);
      alert("Failed to send voice message.");

      // Re-enable the send button in case of an error
      document.getElementById('voice-send-button').disabled = false;
    });
}








// Listen for real-time changes to the 'messages' node in Firebase
db.ref('messages').on('child_changed', snapshot => {
  const updatedMessageData = snapshot.val();
  const messageId = snapshot.key;
  
  console.log(`Message ${messageId} updated:`, updatedMessageData);  // Log the updated message

  // If the message's 'listened' status changes to true, update the UI
  if (updatedMessageData.listened === true) {
    // Find the message in the UI by its message ID
    const statusLabel = document.getElementById(`status-${messageId}`);
    const okButton = document.getElementById(`message-${messageId}`).querySelector('.ok-button');
    
    // Update the status label in the UI
    statusLabel.textContent = "YOUR MESSAGE HAS BEEN LISTENED TO";  // Update status text
    okButton.classList.remove('hidden');  // Show the OK button after the message is listened to
  }
});




// Listen for real-time changes to the 'messages' node in Firebase
function listenForMessageStatus(messageId) {
  const messageRef = db.ref('messages/' + messageId);

  messageRef.on('child_changed', snapshot => {
    const updatedMessageData = snapshot.val();
    const statusLabel = document.getElementById(`status-${messageId}`);
    const okButton = document.getElementById(`message-${messageId}`).querySelector('.ok-button');

    console.log(`Message ${messageId} updated:`, updatedMessageData);  // Log the updated message

    // If the message's 'listened' status changes to true, update the UI
    if (updatedMessageData.listened === true) {
      // Update the UI to show "YOUR MESSAGE HAS BEEN LISTENED TO"
      statusLabel.textContent = "YOUR MESSAGE HAS BEEN LISTENED TO";
      okButton.classList.remove('hidden');  // Show the OK button after the message is listened to
    }
  });
}







// Show success message for message send confirmation
function showSuccessMessage() {
  const successMessage = document.createElement('div');
  successMessage.classList.add('success-message');
  successMessage.textContent = "Message Sent Successfully!";
  document.body.appendChild(successMessage);
}

// Hide success message
function hideSuccessMessage() {
  const successMessage = document.querySelector('.success-message');
  if (successMessage) {
    successMessage.remove();
  }
}

// Display the sent message in the UI
function displaySentMessage(messageData, messageId) {
  const messagesContainer = document.getElementById('sent-messages-container');

  if (!messagesContainer) {
    console.error("Error: 'sent-messages-container' not found in the DOM.");
    return;  // Exit the function if the container is not found
  }

  // Check if the message is already displayed in the UI
  const existingMessage = document.getElementById(`message-${messageId}`);
  if (existingMessage) {
    console.log(`Message ${messageId} is already in the UI. Skipping display.`);
    return; // Prevent the same message from being added again
  }

  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message-item');
  messageDiv.id = `message-${messageId}`; // Set unique ID for the message
  
  // Display the message with initial "listened: false"
  messageDiv.innerHTML = `
    <p><strong>Sender:</strong> ${messageData.sender}</p>
    <p><strong>Sent At:</strong> ${new Date(messageData.timestamp).toLocaleString()}</p>
    <audio controls src="${messageData.voiceNote}" id="audio-${messageId}"></audio>
    <p id="status-${messageId}" class="status">${messageData.listened ? "YOUR MESSAGE HAS BEEN LISTENED TO" : "Your message has not been read"}</p>
    <button onclick="removeMessage('${messageId}')" class="ok-button hidden">OK</button> <!-- Hidden initially -->
  `;
  
  // Add the new message to the container
  messagesContainer.appendChild(messageDiv);

  // Listen for changes to the "listened" status in Firebase
  listenForMessageStatus(messageId);  // Listen for real-time updates for the sent message
}



// Function to update the message UI when it is listened to
// Function to update the message UI when it is listened to
function updateMessageStatusUI(messageId, listened) {
  const statusLabel = document.getElementById(`status-${messageId}`);
  const okButton = document.getElementById(`message-${messageId}`).querySelector('.ok-button');
  
  if (listened) {
    // When the message is listened to, show the green checkmark
    statusLabel.innerHTML = `YOUR MESSAGE HAS BEEN LISTENED TO <span class="checkmark">&#10004;</span>`;
    statusLabel.classList.remove('status-unread');
    statusLabel.classList.add('status-listened');
    
    // Show the OK button
    okButton.classList.remove('hidden');
  } else {
    // When the message has not been listened to, show the unread status
    statusLabel.innerHTML = `Your message has not been read`;
    statusLabel.classList.remove('status-listened');
    statusLabel.classList.add('status-unread');
    
    // Hide the OK button
    okButton.classList.add('hidden');
  }
}







// Fetch and display messages when the page is loaded
function fetchMessages() {
  const messagesContainer = document.getElementById('sent-messages-container');
  
  // Listen for changes in the 'messages' node
  db.ref('messages').on('child_added', snapshot => {
    const messageData = snapshot.val();
    const messageId = snapshot.key;

    // Display the message in the UI (whether it's listened or not)
    displaySentMessage(messageData, messageId);
    
    // Listen for updates to the "listened" status of this message
    listenForMessageStatus(messageId);
  });
}

// Fetch messages from Firebase when the page is loaded
window.addEventListener('load', fetchMessages);






// OK Button Functionality to Remove Message from UI
function removeMessage(messageId) {
  const messageDiv = document.getElementById(`message-${messageId}`);
  if (messageDiv) {
    messageDiv.remove();  // Remove the message from the UI
    // Optionally, remove the message from Firebase if desired
    db.ref('messages/' + messageId).remove()
      .then(() => {
        console.log(`Message ${messageId} removed from Firebase.`);
      })
      .catch(error => {
        console.error("Error removing message from Firebase:", error);
      });
  }
}



// Reset Voice Note Form after sending the message
function resetVoiceMessageForm() {
  voiceBase64 = "";
  voiceChunks = [];
  voiceRecordingSeconds = 0;

  const progressFill = document.getElementById('voice-progress-fill');
  const timeText = document.getElementById('voice-recording-time');

  progressFill.style.width = "0%";
  timeText.textContent = "Recording: 0 seconds";

  document.getElementById('voice-preview').classList.add('hidden');
  document.getElementById('voice-send-button').classList.add('hidden');
  document.getElementById('voice-progress-bar').classList.add('hidden');
  document.getElementById('voice-recording-time').classList.add('hidden');

  document.getElementById('voice-record-button').classList.remove('hidden');
  document.getElementById('voice-stop-button').classList.add('hidden');
}

  
  



  
      // Listen for Incoming Messages

  
  
  
 
</script>

        

    

  
  
  
  
  

  
     





 

  



<Script>

  
  
  

            
 

        
               

  
  
  
  
  
  

        
                

            

  
  function listenForOrderStatusUpdates() {
    const orderHistoryRef = firebase.database().ref('orderHistory');

    orderHistoryRef.on('child_changed', (snapshot) => {
        const orderData = snapshot.val();

        // Use the staffName if available; default to "Staff" if missing
        const staffName = orderData.staffName || "Staff";

        if (orderData.status) {
            let message = "";

            if (orderData.status === "Completed") {
                message = `${staffName}, your order is ready and completed. Go and pick it up now.`;
            } else if (orderData.status === "Cancelled Order") {
                message = `${staffName}, your order has been cancelled.`;
            } else {
                console.log(`No action defined for status: ${orderData.status}`);
                return; // Exit if no action is defined
            }

            readOutText(message, 3);
        } else {
            console.warn("Status field is missing for the updated order.");
        }
    });
}
  
  
  
  
  
  
  
  


/**
 * Use Text-to-Speech to read out a message.
 * @param {string} text - The text to read out loud.
 * @param {number} repeat - Number of times to repeat the message. Default is 1.
 */
function readOutText(text, repeat = 1) {
    for (let i = 0; i < repeat; i++) {
        const speech = new SpeechSynthesisUtterance(text);
        speech.lang = "en-US"; // Set language
        speech.rate = 1; // Set speaking speed
        window.speechSynthesis.speak(speech);
    }
}

// **1. New Message Notification**
db.ref('messages').on('child_added', snapshot => {
    const messageData = snapshot.val();
    readOutText("You have a new message from the kitchen", 3);
    console.log(`New message received from ${messageData.sender}`);
});

// **2. Estimated or Extra Time Added**
db.ref('orders').on('child_changed', snapshot => {
    const order = snapshot.val();
    if (order.extraTime) {
        readOutText(`Extra time of ${order.extraTime} minutes has been added to your order.`, 3);
        console.log(`Extra time added for Order ${snapshot.key}: ${order.extraTime} minutes`);
    } else if (order.estimatedTime) {
        readOutText(`This order will take ${order.estimatedTime} minutes.`, 3);
        console.log(`Estimated time set for Order ${snapshot.key}: ${order.estimatedTime} minutes`);
    }
});



  
  
  
db.ref('orderHistory').orderByChild('timestamp').limitToLast(1).on('child_added', snapshot => {
    const order = snapshot.val();

    // Use the staffName if available; default to "Staff" if missing
    const staffName = order.staffName || "Staff";

    if (order.status) {
        let message = "";

        if (order.status === "Completed") {
            message = `${staffName}, your order is ready and completed. Go and pick it up now.`;
        } else if (order.status === "Cancelled Order") {
            message = `${staffName}, your order has been cancelled.`;
        } else {
            console.log(`No action defined for status: ${order.status}`);
            return; // Exit if no action is defined
        }

        readOutText(message, 3);
    } else {
        console.warn("No status found for the last updated order.");
    }
});

  
  
  
  
  
  
// **5. Time's Up Notification**
function startCountdown(seconds, countdownId, orderKey) {
    const countdownDisplay = document.getElementById(countdownId);
    if (!countdownDisplay) return;

    const interval = setInterval(() => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        countdownDisplay.innerHTML = `Time Remaining: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        seconds--;

        if (seconds < 0) {
            clearInterval(interval);
            countdownDisplay.innerHTML = "Time's Up!";
            countdownDisplay.classList.add("blinking");
            readOutText("Time's up for this order!", 3);
            console.log(`Time's Up for Order ${orderKey}`);
        }
    }, 1000);
}

        
  
  
  
  
  
  

  
  
  
  
  
  
  
        
        
  
  function forceStatusTTS() {
    const orderHistoryRef = firebase.database().ref('orderHistory');

    orderHistoryRef.on('child_changed', (snapshot) => {
        const orderData = snapshot.val();

        // Use the staffName if available; default to "Staff" if missing
        const staffName = orderData.staffName || "Staff";

        if (orderData.status === "Completed") {
            const message = `${staffName}, your order is ready and completed. Go and pick it up now.`;
            readOutText(message, 3);
        } else if (orderData.status === "Cancelled Order") {
            const message = `${staffName}, your order has been cancelled.`;
            readOutText(message, 3);
        }
    });
}
  
  
        
  
  
  window.onload = function () {
    listenForIncomingMessages(); // Existing listener
    forceStatusTTS(); // New standalone listener for status updates
};
  




















function fetchOrdersGroupedByDateAndCountTilapia() {
    const orderHistoryRef = firebase.database().ref('orderHistory');
    const ordersByDateContainer = document.getElementById('orders-by-date-container');
    ordersByDateContainer.innerHTML = ''; // Clear previous content

    orderHistoryRef.once('value', (snapshot) => {
        const orderHistoryData = snapshot.val();

        // Assuming you already have a list of unique dates
        const dates = [
            '11/20/2024', '11/22/2024', '11/26/2024', '11/28/2024' // Replace with actual dates from your list
        ];

        // Loop through all the dates and fetch orders for each
        dates.forEach((date) => {
            // Create the first table to display all items for each date
            let tableHTML = `
                <h3>Orders for ${date}</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Variables to count Tilapia 120, Tilapia 150, and Tilapia 100 (merged with Tilapia 120)
            let tilapia120Count = 0;
            let tilapia150Count = 0;

            let hasOrdersForDate = false; // Flag to track if we have any orders for the selected date
            for (const orderKey in orderHistoryData) {
                const order = orderHistoryData[orderKey];
                const timestamp = new Date(order.timestamp);
                const orderDate = timestamp.toLocaleDateString(); // Format the timestamp to just the date (e.g., MM/DD/YYYY)

                // If the order is from the current date, display it in the table
                if (orderDate === date) {
                    hasOrdersForDate = true;
                    order.items.forEach(item => {
                        tableHTML += `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                            </tr>
                        `;

                        // Count occurrences of Tilapia 120, Tilapia 150, and Tilapia 100 (counted with Tilapia 120)
                        if (item.name.includes("Tilapia 120") || item.name.includes("Tilapia 100")) {
                            tilapia120Count += item.quantity; // Merge Tilapia 100 into Tilapia 120
                        } else if (item.name.includes("Tilapia 150")) {
                            tilapia150Count += item.quantity;
                        }
                    });
                }
            }

            if (!hasOrdersForDate) {
                tableHTML += `<tr><td colspan="2">No orders for this date.</td></tr>`;
            }

            tableHTML += `
                    </tbody>
                </table>
            `;

            // Append the first table to the container
            ordersByDateContainer.innerHTML += tableHTML;

            // Now create the second table to display the counts for Tilapia 120 and Tilapia 150
            let countTableHTML = `
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Total Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Tilapia 120</td>
                            <td>${tilapia120Count}</td>
                        </tr>
                        <tr>
                            <td>Tilapia 150</td>
                            <td>${tilapia150Count}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            // Append the count table below the first table
            ordersByDateContainer.innerHTML += countTableHTML;
        });
    });
}

















  
</script>
  
  
  
  
  
  
  
  
</body>
</html>
<!-- partial -->
  
</body>
</html>
<!-- partial -->
  
</body>
</html>
